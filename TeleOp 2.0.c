#pragma config(Hubs,  S1, HTMotor,  HTMotor,  HTMotor,  HTServo)
#pragma config(Sensor, S1,     ,               sensorI2CMuxController)
#pragma config(Motor,  motorA,           ,             tmotorNXT, openLoop, encoder)
#pragma config(Motor,  motorB,           ,             tmotorNXT, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C1_1,     rightDrive,    tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C1_2,     leftDrive,     tmotorTetrix, openLoop, reversed, encoder)
#pragma config(Motor,  mtr_S1_C2_1,     lift,          tmotorTetrix, openLoop, reversed, encoder)
#pragma config(Motor,  mtr_S1_C2_2,     flag,          tmotorTetrix, openLoop)
#pragma config(Motor,  mtr_S1_C3_1,     arm,           tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C3_2,     bucket,        tmotorTetrix, openLoop, encoder)
#pragma config(Servo,  srvo_S1_C4_1,    dumper,               tServoStandard)
#pragma config(Servo,  srvo_S1_C4_2,    flagMount,            tServoStandard)
#pragma config(Servo,  srvo_S1_C4_3,    flagRaiser,           tServoContinuousRotation)
#pragma config(Servo,  srvo_S1_C4_4,    servo4,               tServoNone)
#pragma config(Servo,  srvo_S1_C4_5,    servo5,               tServoNone)
#pragma config(Servo,  srvo_S1_C4_6,    servo6,               tServoNone)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#include "JoystickDriver.c"  //Include file to "handle" the Bluetooth messages.

void initializeRobot()
{
	servo[dumper] = 233;
	servo[flagMount] = 17;
	return;
}

//ranges: motor power = -100 to +100, joystick = -128 to +128.
//For more prescise movement we normalize the values
const float divider = 0.78125;// used to normalize joystick values
const int driveLowerThreshold = 15;//prevents motors from straining at very low power if the joystick is not at center

task main()
{
	initializeRobot();
	waitForStart();   // wait for start of tele-op phase

	while (true)//infinite loop
	{
		bool isFlagExtended = false;
		bool waitingForRelease = false;
		getJoystickSettings(joystick);	//retrieves current joystick positions
		//Drive Code
		int leftPower = joystick.joy1_y1;
		int rightPower = joystick.joy1_y2;

		//left motor normalization and stopping at low joystick value
		if(abs(leftPower) <= driveLowerThreshold){	//if absolute value is < 15
			leftPower = 0;
		}
		else{
			leftPower = joystick.joy1_y1*divider;	//left motor power= normalized joystick value
		}
		//Left power boost
		if(joy1Btn(8) == 1){	//if Btn 8 is pressed
			leftPower = leftPower+10;	//add 10 to variable
			if(leftPower > 100){	//if its > 100 (the max motor power)
				leftPower = 100;	//then it is just = 100
			}
		}

		//right motor normalization and stopping at low joystick value
		if(abs(rightPower) <= driveLowerThreshold){	//if absolute value is < 15
			rightPower = 0;
		}
		else{
			rightPower = joystick.joy1_y2*divider;	//normalize values
		}
		//Right power Boost
		if(joy1Btn(8) == 1){	//if Btn 8 is pressed
			rightPower = rightPower+10;	//add 10 to variable
			if(rightPower > 100){	//if its > 100 (the max motor power)
				rightPower = 100;	//then it is just = 100
			}
		}
		//setting both motor powers
		motor[leftDrive] = leftPower;
		motor[rightDrive] = rightPower;
		//Lift code
		if(abs(joystick.joy2_y2) > 30){	//if the absolute value is > 30
			if(joystick.joy2_y2 > 0){	//if it's a positive #
				if(joy2Btn(6) == 1){	//if power boost Btn is prsd
					motor[lift] = 100;	//set to high power
				}
				else{
					motor[lift] = 70;	//set to low power
				}
			}
			else{
				if(joy2Btn(6) == 1){
					motor[lift] = -100;
				}
				else{
					motor[lift] = -70;
				}
			}

			//if btn is prsd
			//if encoder is > 50
			//motor = -100
			//else motor = 0
			//else
			//if encoder is > 50
			//motor = -70
			//else motor = 0

		}//end of absolute value if
		else{
			motor[lift] = 0;
		}
		//Arm code
		if(abs(joystick.joy2_y1) > 30){			//if absolute value of joystick is less than 15
			if(joy2Btn(5) == 1){
				motor[arm] = joystick.joy2_y1*45/abs(joystick.joy2_y1);
			}
			else{
				motor[arm] = joystick.joy2_y1*20/abs(joystick.joy2_y1);
			}
		}
		else{
			motor[arm] = 0;
		}
		//Bucket code
		//this section makes it go towards the front of the robot
		if(joystick.joy2_TopHat == 0){ //if tophat is pressed up (0)
			if(joy2Btn(5) == 1){ //if button 5 is pressed
				motor[bucket] = 30; //then bucket power = 30
			}
			else{
				motor[bucket] = 20; //else power =20
			}
		}
		//this section makes the bucket go towards the back of the robot
		else if(joystick.joy2_TopHat == 4){ //if prev is false and tophat is pressed down (4)
			if(joy2Btn(5) == 1){   //if button 5 is pressed
				motor[bucket] = -30; //then bucket power = -30
			}
			else{
				motor[bucket] = -20; //else power = -20
			}
		}
		//Flag code
		if(joy2Btn(1)) {
			if(!waitingForRelease){
				if(!isFlagExtended) {
					servo[flagMount] = 134;
					isFlagExtended = true;//toggle out flag raiser
				}
				else{
					servo[flagMount] = 17;
					isFlagExtended = false;
				}
				waitingForRelease = true;
			}
		}
		else {
			if(waitingForRelease) waitingForRelease = false;
		}
		if(joy2Btn(4)){
			servo[flagMount] = 134;
			motor[flag1] = 100;
			motor[flag2] = 100;
		}
		else if(joy2Btn(2)){
			servo[flagMount] = 134;
			motor[flag1] = 30;
			motor[flag2] = 30;
		}
		else{
			motor[flag1] = 0;
			motor[flag2] = 0;
		}
	}//end bracket of loop
}//end task main bracket
